<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Janus AudioBridge Test Client</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-900 text-white p-6 md:p-10">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-6">Janus AudioBridge Test</h1>

    <!-- Setup -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
      <h2 class="text-xl font-semibold mb-4">1. Setup</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label for="user-id" class="block text-sm font-medium text-gray-300">User ID</label>
          <input type="text" id="user-id" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-white" placeholder="e.g., Alice">
        </div>
        <div>
          <label for="room-id" class="block text-sm font-medium text-gray-300">Room ID</label>
          <input type="number" id="room-id" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-white" placeholder="e.g., 1234">
        </div>
      </div>
      <div class="flex space-x-4 mt-4">
        <button id="create-room-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
          Create Room
        </button>
        <button id="join-room-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
          Join Room
        </button>
      </div>
    </div>

    <!-- Room Controls -->
    <div id="room-controls" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 hidden">
      <h2 class="text-xl font-semibold mb-4">2. Room Controls</h2>
      <div class="flex space-x-4">
        <button id="mute-btn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
          Mute
        </button>
        <button id="leave-room-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
          Leave Room
        </button>
      </div>
    </div>

    <!-- Participants -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
      <h2 class="text-xl font-semibold mb-4">Participants</h2>
      <div id="audio-container" class="space-y-2">
        <p class="text-gray-400">Waiting for participants...</p>
      </div>
    </div>

    <!-- Log -->
    <div class="bg-gray-950 p-4 rounded-lg shadow-inner">
      <h2 class="text-xl font-semibold mb-2">Event Log</h2>
      <pre id="log" class="h-64 overflow-y-auto text-sm text-gray-300 whitespace-pre-wrap"></pre>
    </div>
  </div>

  <script>
    // =====================================================
    // ðŸŒ Configuration
    // =====================================================
    const BASE_URL = "https://codewithketan.me";
    const API_BASE = `${BASE_URL}/api/voice-room`;
    const WS_URL = `${BASE_URL}/ws`; // WebSocket proxy

    // DOM Elements
    const createRoomBtn = document.getElementById('create-room-btn');
    const joinRoomBtn = document.getElementById('join-room-btn');
    const muteBtn = document.getElementById('mute-btn');
    const leaveRoomBtn = document.getElementById('leave-room-btn');
    const userIdInput = document.getElementById('user-id');
    const roomIdInput = document.getElementById('room-id');
    const roomControls = document.getElementById('room-controls');
    const audioContainer = document.getElementById('audio-container');
    const logEl = document.getElementById('log');

    // State
    let stompClient = null;
    let localStream = null;
    let pc = null;
    let userId = '';
    let roomId = '';
    let sessionId = '';
    let handleId = '';
    let isMuted = false;

    function log(message) {
      console.log(message);
      logEl.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // REST API Call helpers
    function getApiUrl(path) {
      return `${API_BASE}${path}`;
    }

    // =====================================================
    // ðŸ— Create Room
    // =====================================================
    createRoomBtn.onclick = async () => {
      userId = userIdInput.value;
      if (!userId) return log('âŒ Please enter a User ID.');
      log('ðŸŽ¤ Creating room...');
      try {
        const res = await fetch(getApiUrl(`/create?displayName=${encodeURIComponent(userId)}`), { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Server error');
        sessionId = data.sessionId;
        handleId = data.handleId;
        roomId = data.roomId;
        roomIdInput.value = roomId;
        log(`âœ… Room created: ${roomId}`);
        connectAndRegister();
      } catch (err) {
        log('âŒ Error: ' + err.message);
      }
    };

    // =====================================================
    // ðŸ‘‚ Join Room
    // =====================================================
    joinRoomBtn.onclick = async () => {
      userId = userIdInput.value;
      roomId = roomIdInput.value;
      if (!userId || !roomId) return log('âŒ Please enter User ID & Room ID.');
      log(`ðŸŽ§ Joining room ${roomId}...`);
      try {
        const res = await fetch(getApiUrl(`/join?roomId=${roomId}&displayName=${encodeURIComponent(userId)}`), { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Server error');
        sessionId = data.sessionId;
        handleId = data.handleId;
        log(`âœ… Joined room ${roomId}`);
        connectAndRegister();
      } catch (err) {
        log('âŒ Error joining: ' + err.message);
      }
    };

    // =====================================================
    // ðŸ”Œ Connect via WebSocket
    // =====================================================
    async function connectAndRegister() {
      log('ðŸ”— Connecting WebSocket...');
      const socket = new SockJS(WS_URL);
      stompClient = Stomp.over(socket);
      stompClient.connect({}, (frame) => {
        log('âœ… WebSocket Connected');

        stompClient.subscribe(`/topic/room/${roomId}/events`, (msg) => handleRoomEvent(JSON.parse(msg.body)));
        stompClient.subscribe(`/topic/room/${roomId}/answer/${userId}`, (msg) => handleJanusEvent(JSON.parse(msg.body)));

        stompClient.send('/app/register', {}, JSON.stringify({
          userId, sessionId, handleId, roomId
        }));

        setTimeout(startPeerConnection, 300);
        roomControls.classList.remove('hidden');
      }, (err) => log('âŒ WS error: ' + err));
    }

    // =====================================================
    // ðŸŽ¥ WebRTC Setup
    // =====================================================
    async function startPeerConnection() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (err) {
        return log('âŒ Audio error: ' + err.message);
      }

      pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.ontrack = (event) => {
        const audio = document.createElement('audio');
        audio.autoplay = true;
        audio.srcObject = event.streams[0];
        audioContainer.innerHTML = '';
        audioContainer.appendChild(audio);
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          stompClient.send('/app/ice', {}, JSON.stringify({
            userId, roomId, candidate: event.candidate
          }));
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      stompClient.send('/app/offer', {}, JSON.stringify({
        userId, roomId, sdp: offer.sdp
      }));
    }

function handleJanusEvent(resp) {
  try {
    // 1ï¸âƒ£ Handle SDP Answer
    if (resp.jsep) {
      const answer = resp.jsep;
      log('âœ… Received SDP Answer.');
      pc.setRemoteDescription(new RTCSessionDescription({
        type: answer.type,
        sdp: answer.sdp
      })).catch(e => log('setRemoteDescription error: ' + e));
    }

    // 2ï¸âƒ£ Handle single trickle candidate
    if (resp.candidate) {
      const c = resp.candidate;

      // Ignore "completed" signals (no candidate info)
      if (c.completed) {
        log('ðŸ§Š ICE gathering complete signal received.');
        return;
      }

      // Only add if candidate + proper indices exist
      if (c.candidate && c.sdpMid != null && c.sdpMLineIndex != null) {
        log(`ðŸ§Š Adding remote ICE candidate: ${c.candidate}`);
        pc.addIceCandidate(new RTCIceCandidate({
          candidate: c.candidate,
          sdpMid: c.sdpMid,
          sdpMLineIndex: c.sdpMLineIndex
        })).catch(e => log('addIceCandidate error: ' + e));
      } else {
        log('âš ï¸ Ignored incomplete ICE candidate: ' + JSON.stringify(c));
      }
    }

    // 3ï¸âƒ£ Handle batch candidates (from plugindata)
    if (resp.plugindata && resp.plugindata.data) {
      const pdata = resp.plugindata.data;

      if (pdata.candidates && Array.isArray(pdata.candidates)) {
        pdata.candidates.forEach(c => {
          if (c.candidate && c.sdpMid != null && c.sdpMLineIndex != null) {
            log(`ðŸ§Š Adding batch ICE candidate: ${c.candidate}`);
            pc.addIceCandidate(new RTCIceCandidate({
              candidate: c.candidate,
              sdpMid: c.sdpMid,
              sdpMLineIndex: c.sdpMLineIndex
            })).catch(e => log('addIceCandidate error: ' + e));
          }
        });
      }

      // Handle hangup/leaving
      if (pdata.hangup || pdata.leaving) {
        log('ðŸ‘‹ Remote peer left/hung up: ' + JSON.stringify(pdata));
      }
    }
  } catch (err) {
    log('âŒ handleJanusEvent processing error: ' + err);
  }
}


    function handleRoomEvent(event) {
      log(`ðŸ“¢ Room Event: ${event.type} - ${event.userId}`);
    }

    muteBtn.onclick = () => {
      isMuted = !isMuted;
      localStream.getAudioTracks()[0].enabled = !isMuted;
      muteBtn.textContent = isMuted ? 'Unmute' : 'Mute';
    };

    leaveRoomBtn.onclick = () => {
      stompClient.disconnect();
      pc.close();
      localStream.getTracks().forEach(t => t.stop());
      roomControls.classList.add('hidden');
      log('ðŸ‘‹ Left the room');
    };
  </script>
</body>
</html>
