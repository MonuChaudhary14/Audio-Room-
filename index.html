<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SpaceHub Voice Rooms (Persistent)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    pre::-webkit-scrollbar { width: 8px; }
    pre::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center py-10">

  <div class="w-full max-w-5xl bg-gray-800 rounded-2xl shadow-lg p-6 space-y-6">

    <!-- Header -->
    <div class="text-center">
      <h1 class="text-3xl font-bold text-indigo-400">üéô SpaceHub Voice Rooms</h1>
      <p class="text-gray-400 mt-2 text-sm">Persistent Janus AudioBridge Rooms (like Discord)</p>
    </div>

    <!-- Chat Room Input -->
    <div class="bg-gray-900 p-5 rounded-xl shadow-md flex space-x-4 items-center">
      <input id="chatRoomId" placeholder="Enter Chat Room UUID"
             class="flex-1 p-2 rounded bg-gray-700 text-white focus:ring focus:ring-indigo-500">
      <button id="loadRoomsBtn" 
              class="bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded font-semibold">Load Rooms</button>
    </div>

    <!-- Create Room -->
    <div class="bg-gray-900 p-5 rounded-xl shadow-md">
      <h2 class="text-xl font-semibold mb-4 text-indigo-300">Create Voice Room</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <input id="roomName" placeholder="Room name (e.g., Gaming VC)" 
               class="p-2 rounded bg-gray-700 text-white focus:ring focus:ring-indigo-500">
        <input id="createdBy" placeholder="Your name"
               class="p-2 rounded bg-gray-700 text-white focus:ring focus:ring-indigo-500">
        <button id="createRoomBtn" 
                class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-semibold">Create</button>
      </div>
    </div>

    <!-- Existing Rooms -->
    <div id="voiceRoomsContainer" class="bg-gray-900 p-5 rounded-xl shadow-md">
      <h2 class="text-xl font-semibold mb-4 text-green-300">Available Voice Rooms</h2>
      <div id="roomsList" class="space-y-2 text-gray-300 text-sm">
        <p class="text-gray-400">Load a chat room to view voice rooms.</p>
      </div>
    </div>

    <!-- Room Info -->
    <div id="roomInfo" class="bg-gray-900 p-5 rounded-xl shadow-md hidden">
      <h2 class="text-lg font-semibold text-blue-300 mb-2">Current Room</h2>
      <p><strong>Room ID:</strong> <span id="infoRoomId" class="text-indigo-400"></span></p>
      <p><strong>Session ID:</strong> <span id="infoSessionId" class="text-indigo-400"></span></p>
      <p><strong>Handle ID:</strong> <span id="infoHandleId" class="text-indigo-400"></span></p>
    </div>

    <!-- Controls -->
    <div id="roomControls" class="bg-gray-900 p-5 rounded-xl shadow-md hidden">
      <h2 class="text-lg font-semibold text-yellow-300 mb-3">Room Controls</h2>
      <div class="flex space-x-4">
        <button id="muteBtn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 py-2 rounded font-semibold">Mute</button>
        <button id="leaveBtn" class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded font-semibold">Leave Room</button>
      </div>
    </div>

    <!-- Participants -->
    <div class="bg-gray-900 p-5 rounded-xl shadow-md">
      <h2 class="text-lg font-semibold text-purple-300 mb-3">Participants</h2>
      <div id="audioContainer" class="text-gray-400 text-sm">Waiting for participants...</div>
    </div>

    <!-- Logs -->
    <div class="bg-gray-950 p-4 rounded-xl shadow-inner">
      <h2 class="text-lg font-semibold text-gray-300 mb-2">Event Log</h2>
      <pre id="log" class="h-60 overflow-y-auto text-sm text-gray-400"></pre>
    </div>
  </div>

  <script>
    const BASE_URL = "https://codewithketan.me"; // change this to your backend
    const API_BASE = `${BASE_URL}/api/v1/voice-room`;
    const WS_URL = `${BASE_URL}/ws`;

    // Elements
    const chatRoomIdInput = document.getElementById("chatRoomId");
    const loadRoomsBtn = document.getElementById("loadRoomsBtn");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const roomNameInput = document.getElementById("roomName");
    const createdByInput = document.getElementById("createdBy");
    const roomsList = document.getElementById("roomsList");

    const infoRoomId = document.getElementById("infoRoomId");
    const infoSessionId = document.getElementById("infoSessionId");
    const infoHandleId = document.getElementById("infoHandleId");
    const roomInfo = document.getElementById("roomInfo");
    const roomControls = document.getElementById("roomControls");
    const muteBtn = document.getElementById("muteBtn");
    const leaveBtn = document.getElementById("leaveBtn");
    const audioContainer = document.getElementById("audioContainer");
    const logEl = document.getElementById("log");

    // State
    let stompClient = null, pc = null, localStream = null;
    let chatRoomId = "", roomId = "", sessionId = "", handleId = "", userId = "", isMuted = false;

    const log = (msg) => {
      console.log(msg);
      logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    };

    // üîπ Load Voice Rooms
    loadRoomsBtn.onclick = async () => {
      chatRoomId = chatRoomIdInput.value.trim();
      if (!chatRoomId) return alert("Enter a valid Chat Room ID");

      try {
        const res = await fetch(`${API_BASE}/list/${chatRoomId}`);
        const data = await res.json();
        renderRooms(data.rooms || []);
      } catch (err) {
        log("‚ùå Error loading rooms: " + err.message);
      }
    };

    function renderRooms(rooms) {
      if (!rooms.length) {
        roomsList.innerHTML = "<p class='text-gray-400'>No voice rooms found. Create one above!</p>";
        return;
      }
      roomsList.innerHTML = rooms.map(r => `
        <div class="flex justify-between bg-gray-800 p-3 rounded-lg hover:bg-gray-700 cursor-pointer"
             onclick="joinExistingRoom(${r.janusRoomId}, '${r.name}')">
          <div>üéß ${r.name}</div>
          <div class="text-xs text-gray-400">Created by ${r.createdBy}</div>
        </div>
      `).join('');
    }

    // üîπ Create New Voice Room
    createRoomBtn.onclick = async () => {
      chatRoomId = chatRoomIdInput.value.trim();
      const name = roomNameInput.value.trim();
      const createdBy = createdByInput.value.trim();
      if (!chatRoomId || !name || !createdBy) return alert("Please fill all fields");

      try {
        log("üß© Creating voice room...");
        const res = await fetch(`${API_BASE}/create?chatRoomId=${chatRoomId}&name=${encodeURIComponent(name)}&createdBy=${encodeURIComponent(createdBy)}`, { method: "POST" });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Failed to create room");
        log("‚úÖ Room created successfully: " + data.room.name);
        loadRoomsBtn.click(); // reload list
      } catch (err) {
        log("‚ùå Error creating room: " + err.message);
      }
    };

    // üîπ Join Existing Room
    async function joinExistingRoom(janusRoomId, name) {
      const displayName = prompt(`Enter your display name to join "${name}":`);
      if (!displayName) return;
      userId = displayName;
      log(`üéß Joining room ${name} (${janusRoomId})...`);

      try {
        const res = await fetch(`${API_BASE}/join?janusRoomId=${janusRoomId}&displayName=${encodeURIComponent(displayName)}`, { method: "POST" });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message);
        sessionId = data.sessionId;
        handleId = data.handleId;
        roomId = janusRoomId;
        updateRoomInfo();
        connectWebSocket();
      } catch (err) {
        log("‚ùå Join failed: " + err.message);
      }
    }

    // üîπ WebSocket & WebRTC Logic (same as your working version)
    function connectWebSocket() {
      const socket = new SockJS(WS_URL);
      stompClient = Stomp.over(socket);
      stompClient.connect({}, () => {
        log("üîó Connected to WebSocket");
        stompClient.subscribe(`/topic/room/${roomId}/events`, (msg) => handleRoomEvent(JSON.parse(msg.body)));
        stompClient.subscribe(`/topic/room/${roomId}/answer/${userId}`, (msg) => handleJanusEvent(JSON.parse(msg.body)));
        stompClient.send("/app/register", {}, JSON.stringify({ userId, sessionId, handleId, roomId }));
        setTimeout(startPeerConnection, 300);
        roomControls.classList.remove("hidden");
      }, (err) => log("‚ùå WebSocket error: " + err));
    }

    async function startPeerConnection() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        log("üé§ Microphone access granted");
      } catch (err) {
        return log("‚ùå Audio Error: " + err.message);
      }

      pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.ontrack = (event) => {
        const audio = document.createElement("audio");
        audio.autoplay = true;
        audio.srcObject = event.streams[0];
        audioContainer.innerHTML = "";
        audioContainer.appendChild(audio);
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          stompClient.send("/app/ice", {}, JSON.stringify({ userId, roomId, candidate: event.candidate }));
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      stompClient.send("/app/offer", {}, JSON.stringify({ userId, roomId, sdp: offer.sdp }));
    }

    function handleJanusEvent(resp) {
      try {
        if (resp.jsep) {
          pc.setRemoteDescription(new RTCSessionDescription(resp.jsep));
          log("‚úÖ SDP Answer set");
        }
        if (resp.candidate && resp.candidate.candidate) {
          pc.addIceCandidate(new RTCIceCandidate(resp.candidate));
        }
      } catch (e) { log("‚ùå handleJanusEvent error: " + e); }
    }

    function handleRoomEvent(event) {
      log(`üì¢ Room Event: ${event.type} - ${event.userId}`);
    }

    function updateRoomInfo() {
      infoRoomId.textContent = roomId;
      infoSessionId.textContent = sessionId;
      infoHandleId.textContent = handleId;
      roomInfo.classList.remove("hidden");
    }

    muteBtn.onclick = () => {
      isMuted = !isMuted;
      localStream.getAudioTracks()[0].enabled = !isMuted;
      muteBtn.textContent = isMuted ? "Unmute" : "Mute";
      log(isMuted ? "üîá Muted" : "üîä Unmuted");
    };

    leaveBtn.onclick = () => {
      stompClient?.disconnect();
      pc?.close();
      localStream?.getTracks().forEach(t => t.stop());
      roomControls.classList.add("hidden");
      log("üëã Left the room");
    };
  </script>
</body>
</html>
